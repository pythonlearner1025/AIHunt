<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Among Us — Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ---------- Reset / Base ---------- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font: 15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: #111;
      background: #fff;
      /* Own the viewport and stop body from scrolling; inner pane will scroll */
      min-height: 100vh;    /* fallback */
      min-height: 100svh;   /* small viewport (iOS toolbars visible) */
      min-height: 100dvh;   /* dynamic viewport (preferred) */
      overflow: hidden;
    }

    /* ---------- App Shell ---------- */
    .app {
      height: 100%;
      display: flex;
      flex-direction: column;
      /* Allow the middle pane to actually shrink/scroll */
      min-height: 0;
    }

    .app-header {
      flex: 0 0 auto;
      border-bottom: 1px solid #e5e5e5;
      background: #fafafa;
      padding: 12px 16px;
    }
    .app-title { font-weight: 700; font-size: 18px; margin: 0 0 4px; }
    .app-sub { font-size: 12px; color: #6b7280; }

    /* Optional tiny lobby strip (hidden once joined) */
    #lobbyStrip {
      flex: 0 0 auto;
      border-bottom: 1px solid #f0f0f0;
      padding: 10px 16px;
      background: #fff;
    }

    /* ---------- Chat Column ---------- */
    .chat {
      /* Fill the rest of the viewport */
      flex: 1 1 auto;
      min-height: 0; /* critical for scroll containers inside flex */
      display: flex;
      flex-direction: column;
      /* Prevent scroll chaining to body */
      overscroll-behavior: contain;
    }

    .messages {
      flex: 1 1 auto;
      min-height: 0;               /* critical */
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch; /* momentum on iOS */
      scrollbar-gutter: stable both-edges;
      background: #f9fafb;
    }

    .msg-list { list-style: none; margin: 0; padding: 0; }

    .msg {
      margin: 10px 0;
      max-width: 900px; /* content line-length; not the layout width */
    }
    .msg .meta {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .msg .sender { font-weight: 600; color: #111; margin-right: 8px; }
    .msg .time { color: #9ca3af; }
    .msg .text {
      font-size: 15px;
      color: #111;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px 12px;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .msg.system {
      text-align: center;
      color: #6b7280;
      font-size: 13px;
    }
    .msg.chat-system {
      text-align: center;
      color: #789922;
      font-size: 13px;
    }

    /* ---------- Composer ---------- */
    .composer {
      flex: 0 0 auto;
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 12px 16px;
      border-top: 1px solid #e5e5e5;
      background: #fafafa;
      /* Respect notches / home indicator on mobile */
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .input {
      flex: 1;
      min-width: 0; /* allow shrinking in flex */
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 15px;
      outline: none;
    }
    .input:focus { border-color: #9ca3af; }
    .send {
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      background: #111827;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .send:hover { background: #0b1220; }

    /* ---------- Join Overlay ---------- */
    #joinOverlay {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(2px);
    }
    #joinCard {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      width: min(520px, 92vw);
      display: grid;
      gap: 12px;
    }
    #joinBtn {
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      background: #111827;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    #joinBtn:hover { background: #0b1220; }

    /* ---------- Voting Popup ---------- */
    #votingOverlay {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
    }
    #votingOverlay.show { display: grid; }
    
    #votingCard {
      background: #fff;
      border: 2px solid #333;
      border-radius: 16px;
      padding: 24px;
      width: min(500px, 90vw);
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    #votingTimer {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 20px;
      color: #111;
    }
    
    .voting-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }
    
    .vote-square {
      border: 2px solid #d1d5db;
      border-radius: 12px;
      padding: 20px;
      background: #f9fafb;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .vote-square:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
      transform: scale(1.02);
    }
    .vote-square.voted {
      background: #dbeafe;
      border-color: #3b82f6;
    }
    .vote-square.highlight-red {
      border-color: #dc2626 !important;
      color: #dc2626 !important;
      border-width: 3px;
      animation: pulse-red 0.5s ease-in-out;
    }
    .vote-square.highlight-green {
      border-color: #16a34a !important;
      color: #16a34a !important;
      border-width: 3px;
      animation: pulse-green 0.5s ease-in-out;
    }
    
    .player-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .vote-count {
      font-size: 20px;
      font-weight: 700;
      color: #374151;
    }
    
    @keyframes pulse-red {
      0%, 100% { background: #fee2e2; }
      50% { background: #fecaca; }
    }
    @keyframes pulse-green {
      0%, 100% { background: #dcfce7; }
      50% { background: #bbf7d0; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="app-header">
      <h1 class="app-title">AI Among Us</h1>
      <div class="app-sub">Your name: <span id="idContent">—</span></div>
    </header>

    <!-- Lobby strip (optional; hidden once the game actually starts) -->
    <section id="lobbyStrip" hidden>
      <div style="font-weight:600;margin-bottom:6px;">Lobby</div>
      Players: <div id="playersCount" style="display: inline;">0/4</div>
      <br>
      Votes: <div id="votesCount" style="display: inline;">0/2</div>
      <ul id="players" style="margin-top:6px;color:#6b7280;padding-left:16px;"></ul>
    </section>

    <main class="chat">
      <div class="messages" id="messagesPane">
        <ul class="msg-list" id="messages"></ul>
      </div>

      <form class="composer" id="composer" autocomplete="off">
        <input class="input" id="messageText" type="text" placeholder="Type a message…" />
        <button class="send" id="sendBtn" type="submit">Send</button>
      </form>

      <!-- Join overlay -->
      <div id="joinOverlay">
        <div id="joinCard">
          <div style="font-weight:700;">Join Game</div>
          <div style="font-size:13px;color:#6b7280;">Connect to the lobby and start chatting.</div>
          <button id="joinBtn" type="button">Join</button>
        </div>
      </div>

      <!-- Voting overlay -->
      <div id="votingOverlay">
        <div id="votingCard">
          <div id="votingTimer">10s</div>
          <div style="text-align:center;font-weight:600;margin-bottom:8px;">Vote for the AI</div>
          <div class="voting-grid" id="votingGrid"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ---- Utilities ----
    const messagesEl = document.getElementById('messages');
    const paneEl = document.getElementById('messagesPane');

    function fmt(tsSec) {
      const d = new Date(tsSec * 1000);
      const h = d.getHours();
      const m = String(d.getMinutes()).padStart(2, '0');
      const a = h >= 12 ? 'PM' : 'AM';
      const hh = h % 12 || 12;
      return `${hh}:${m} ${a}`;
    }

    function nearBottom(container, threshold = 96) {
      return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
    }

    function appendMessage({ sender, text, ts, system = false }) {
      const li = document.createElement('li');
      if (system) {
        li.className = 'msg system';
        li.textContent = text;
      } else if (sender === 'system') {
        li.className = 'msg chat-system';
        li.textContent = text;
      } else {
        li.className = 'msg';
        li.innerHTML = `
          <div class="meta"><span class="sender">${sender}</span><span class="time">${fmt(ts)}</span></div>
          <div class="text"></div>`;
        li.querySelector('.text').textContent = text;
      }
      const stick = nearBottom(paneEl);
      messagesEl.appendChild(li);
      if (stick) requestAnimationFrame(() => { paneEl.scrollTop = paneEl.scrollHeight; });
    }

    // Keep pinned to bottom across resizes if the user was already at bottom
    (function keepPinned() {
      let pinned = true;
      paneEl.addEventListener('scroll', () => { pinned = nearBottom(paneEl); }, { passive: true });
      window.addEventListener('resize', () => { if (pinned) paneEl.scrollTop = paneEl.scrollHeight; });
    })();

    // ---- Join / Lobby / WS wiring ----
    const joinOverlay = document.getElementById('joinOverlay');
    const lobbyStrip = document.getElementById('lobbyStrip');
    const playersCount = document.getElementById('playersCount');
    const playersList = document.getElementById('players');
    const votesCount = document.getElementById('votesCount');
    const idContent = document.getElementById('idContent');

    let ws = null;
    let joined = false;
    let votingActive = false;
    let votingTimer = null;
    let votedFor = null;

    document.getElementById('joinBtn').addEventListener('click', joinGame);
    document.getElementById('composer').addEventListener('submit', sendMessage);

    async function joinGame() {
      // Fetch join info
      const res = await fetch('/join_game', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();
      if (data.status !== 'ok') {
        appendMessage({ system: true, text: 'Failed to join lobby.' });
        return;
      }

      joined = true;
      joinOverlay.style.display = 'none';
      lobbyStrip.hidden = false;

      idContent.textContent = data.player_id || 'unknown';

      // Populate initial players list
      const players = (data.players ? data.players.split(',') : []);
      playersCount.textContent = `${players.length}/4`;
      playersList.innerHTML = players.map(p => `<li>${p}</li>`).join('');

      // Open WebSocket
      const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
      const wsUrl = `${proto}://${location.host}/ws/${data.lobby_id}/${data.player_id}`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        appendMessage({ system: true, text: 'Connected to lobby.' });
      };

      ws.onclose = () => {
        appendMessage({ system: true, text: 'Disconnected.' });
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'history' && Array.isArray(msg.messages)) {
          // Load history and force bottom after initial batch
          msg.messages.forEach(m => appendMessage({ sender: m.sender, text: m.message, ts: m.timestamp }));
          requestAnimationFrame(() => { paneEl.scrollTop = paneEl.scrollHeight; });
        } else if (msg.type === 'message') {
          appendMessage({ sender: msg.sender, text: msg.message, ts: msg.timestamp });
        } else if (msg.type === 'player_update') {
          const ps = msg.players || [];
          playersCount.textContent = `${ps.length}/4`;
          playersList.innerHTML = ps.map(p => `<li>${p}</li>`).join('');
        } else if (msg.type === 'vote_update') {
          const voteCount = msg.votes || 0;
          votesCount.textContent = `${voteCount}/2`;
        } else if (msg.type === 'system') {
          appendMessage({ system: true, text: msg.message });
        } else if (msg.type === 'voting_phase_start') {
          startVoting(msg.players, msg.vote_time);
        } else if (msg.type === 'vote_count_update') {
          updateVoteCounts(msg.vote_counts);
        } else if (msg.type === 'voting_phase_end') {
          endVoting(msg.most_voted);
        } else if (msg.type === 'ai_reveal') {
          revealAI(msg.ai_player);
        }
      };
    }

    function sendMessage(e) {
      e.preventDefault();
      const input = document.getElementById('messageText');
      const value = input.value.trim();
      if (!value) return;
      
      const data = value === "/vote"
        ? { type: 'vote_request', content: true }  // This will increment vote count and update the Lobby span
        : { type: 'message', content: value };

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(data));
      } else {
        appendMessage({ sender: 'Me', text: value, ts: Math.floor(Date.now() / 1000) });
      }
      
      input.value = '';
      requestAnimationFrame(() => { paneEl.scrollTop = paneEl.scrollHeight; });
    }


    // Voting phase functions
    function startVoting(players, voteTime) {
      votingActive = true;
      votedFor = null;
      const overlay = document.getElementById('votingOverlay');
      const grid = document.getElementById('votingGrid');
      const timerEl = document.getElementById('votingTimer');
      
      // Clear previous content
      grid.innerHTML = '';
      
      // Create voting squares for each player (max 4 for 2x2 grid)
      players.slice(0, 4).forEach(player => {
        const square = document.createElement('div');
        square.className = 'vote-square';
        square.dataset.player = player;
        square.innerHTML = `
          <div class="player-name">${player}</div>
          <div class="vote-count" data-player="${player}">0</div>
        `;
        square.addEventListener('click', () => castVote(player));
        grid.appendChild(square);
      });
      
      // Show overlay
      overlay.classList.add('show');
      
      // Start countdown timer
      let timeLeft = voteTime;
      timerEl.textContent = `${timeLeft}s`;
      votingTimer = setInterval(() => {
        timeLeft--;
        timerEl.textContent = `${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(votingTimer);
        }
      }, 1000);
    }
    
    function castVote(player) {
      if (!votingActive || !ws || ws.readyState !== WebSocket.OPEN) return;
      
      // Update UI to show selection
      document.querySelectorAll('.vote-square').forEach(sq => {
        sq.classList.remove('voted');
      });
      const square = document.querySelector(`.vote-square[data-player="${player}"]`);
      if (square) square.classList.add('voted');
      
      votedFor = player;
      
      // Send vote to server
      ws.send(JSON.stringify({
        type: 'cast_vote',
        target: player
      }));
    }
    
    function updateVoteCounts(voteCounts) {
      Object.entries(voteCounts).forEach(([player, count]) => {
        const countEl = document.querySelector(`.vote-count[data-player="${player}"]`);
        if (countEl) countEl.textContent = count;
      });
    }
    
    function endVoting(mostVoted) {
      votingActive = false;
      clearInterval(votingTimer);
      
      // Highlight the most voted player in red
      if (mostVoted) {
        const square = document.querySelector(`.vote-square[data-player="${mostVoted}"]`);
        if (square) {
          square.classList.add('highlight-red');
        }
      }
    }
    
    function revealAI(aiPlayer) {
      // Remove red highlights
      document.querySelectorAll('.vote-square').forEach(sq => {
        sq.classList.remove('highlight-red');
      });
      
      // Highlight the AI player in green
      if (aiPlayer) {
        const square = document.querySelector(`.vote-square[data-player="${aiPlayer}"]`);
        if (square) {
          square.classList.add('highlight-green');
        }
      }
      
      // Hide overlay after a delay
      setTimeout(() => {
        document.getElementById('votingOverlay').classList.remove('show');
        document.getElementById('votingGrid').innerHTML = '';
      }, 2000);
    }

    // Demo: render a system message so the pane isn't empty before join
    appendMessage({ system: true, text: 'Join the lobby to start chatting.' });
  </script>
</body>
</html>
